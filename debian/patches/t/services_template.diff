From: Jiang Xin <worldhello.net@gmail.com>
Subject: [PATCH] t/services_template

<patch description>

Signed-off-by: Jiang Xin <worldhello.net@gmail.com>

---
 html/Makefile.in             |   2 +-
 html/services/config_inc.php |  18 +++
 html/services/index.php      | 270 +++++++++++++++++++++++++++++++++++++++++++
 html/services/ldap_api.php   | 107 +++++++++++++++++
 4 files changed, 396 insertions(+), 1 deletion(-)

diff --git a/html/Makefile.in b/html/Makefile.in
index d9ac434..e0057ad 100755
--- a/html/Makefile.in
+++ b/html/Makefile.in
@@ -28,6 +28,6 @@ install : all
 	-mkdir -p ${DESTDIR}${HTMLDIR}/js
 	cp js/*.js ${DESTDIR}${HTMLDIR}/js/
 	-mkdir -p ${DESTDIR}${SERVICESDIR}
-	cp services/*.html ${DESTDIR}${SERVICESDIR}/
+	cp services/*.html services/*.php ${DESTDIR}${SERVICESDIR}/
 
 clean:
diff --git a/html/services/config_inc.php b/html/services/config_inc.php
new file mode 100644
index 0000000..54f9c0c
--- /dev/null
+++ b/html/services/config_inc.php
@@ -0,0 +1,18 @@
+<?php
+
+$url_gosa = "https://members.foo.bar/members/?login";
+$url_logout = "https://weblogin.foo.bar/cgi-bin/logout";
+
+#############################
+# LDAP Settings
+#############################
+
+$g_ldap_server		= 'ldap://localhost/';
+$g_ldap_port		= '389';
+$g_ldap_root_dn		= 'dc=foo,dc=bar';
+$g_ldap_organizatio	= '(ossxpConfirmed=TRUE)';
+$g_ldap_uid_field	= 'uid';
+$g_ldap_bind_dn	= 'cn=ldapadmin,dc=foo,dc=bar';
+$g_ldap_bind_passwd	= 'guess';
+
+?>
diff --git a/html/services/index.php b/html/services/index.php
new file mode 100644
index 0000000..e189185
--- /dev/null
+++ b/html/services/index.php
@@ -0,0 +1,270 @@
+<?php
+
+require_once("config_inc.php");
+require_once("ldap_api.php");
+
+if (array_key_exists("logout", $_REQUEST))
+{
+  if (@$_SERVER['COSIGN_SERVICE'] || @$_SERVER['REDIRECT_COSIGN_SERVICE'])
+  {
+    $cookie_name = @$_SERVER["COSIGN_SERVICE"] ? @$_SERVER["COSIGN_SERVICE"] : @$_SERVER["REDIRECT_COSIGN_SERVICE"];
+    setcookie( $cookie_name, "null", time()-1, '/', "", 0 );
+    setcookie( $cookie_name, "null", time()-1 );
+  }
+  Header( "Location: $url_logout" );
+  exit(0);
+}
+
+$uid = @$_SERVER["REMOTE_USER"]? @$_SERVER["REMOTE_USER"] : @$_SERVER["REDIRECT_REMOTE_USER"];
+if (!$uid)
+{
+  die("Not login yet.");
+}
+
+# If auth using invite factor, userid is from factor name.
+$factor = @$_SERVER["COSIGN_FACTOR"]? @$_SERVER["COSIGN_FACTOR"] : @$_SERVER["REDIRECT_COSIGN_FACTOR"];
+if ($factor && preg_match("/^invite_.*/", $factor)) {
+  $uid = substr($factor, 7);
+  $mail = @$_SERVER["REMOTE_USER"]? @$_SERVER["REMOTE_USER"] : @$_SERVER["REDIRECT_REMOTE_USER"];
+}
+
+$info=ldap_brief_info($uid);
+$uid=$info['uid'];
+
+$username = !($info['givenname'] && $info['sn']) && $info['givenname'] ? $info['givenname'] : $info['sn'];
+if ( $username != $info['givenname'] || $info['givenname'] != "")
+{
+   $username .=  " ".$info['givenname'];
+}
+else if (!$username)
+{
+  $username = $uid;
+}
+
+if ($info['cn'])
+  $aliasname = $info['cn'];
+else if ($username)
+  $aliasname = $username;
+else
+  $aliasname = $uid;
+
+if ($info['mail'])
+  $mail = $info['mail'];
+
+?>
+<html><head>
+<meta http-equiv="content-type" content="text/html; charset=UTF-8">
+<meta http-equiv="Pragma" content="no-cache" />
+<meta http-equiv="Expires" content="Monday, 16-Apr-73 13:10:00 GMT" />
+<title>欢迎, <?php echo $username; ?></title>
+<script><!--
+function gaia_setFocus() {
+  var f = null;
+  if (document.getElementById) { 
+    f = document.getElementById("gaia_loginform");
+  } else if (window.gaia_loginform) { 
+    f = window.gaia_loginform;
+  } 
+  if (f) {
+    if (f.login && (f.login.value == null || f.login.value == "")) {
+      f.login.focus();
+    } else if (f.password) {
+      f.password.focus();
+    } 
+  }
+}
+--></script>
+<style type="text/css">
+  <!--
+  body { font-family: arial,sans-serif; background-color: #fff; margin-top: 2; }
+  .c { width: 4; height: 4; } 
+  a:link { color: #00c; } 
+  a:visited { color: #551a8b; }
+  a:active { color: #f00; }
+  .form-noindent { background-color: #fff; border: 1px solid #c3d9ff; }
+  -->
+</style>
+<style type="text/css"><!--
+.gaia.le.lbl { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.fpwd { font-family: Arial, Helvetica, sans-serif; font-size: 70%; }
+.gaia.le.chusr { font-family: Arial, Helvetica, sans-serif; font-size: 70%; }
+.gaia.le.val { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.button { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.rem { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+
+.gaia.captchahtml.desc { font-family: arial, sans-serif; font-size: smaller; } 
+.gaia.captchahtml.cmt { font-family: arial, sans-serif; font-size: smaller; font-style: italic; }
+  
+--></style>
+<style type="text/css"><!--
+  div.errormsg { color: red; font-size: smaller; font-family:arial,sans-serif; }
+  font.errormsg { color: red; font-size: smaller; font-family:arial,sans-serif; }  
+--></style>
+<style type="text/css"><!--
+.gaia.le.lbl { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.fpwd { font-family: Arial, Helvetica, sans-serif; font-size: 70%; }
+.gaia.le.chusr { font-family: Arial, Helvetica, sans-serif; font-size: 70%; }
+.gaia.le.val { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.button { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+.gaia.le.rem { font-family: Arial, Helvetica, sans-serif; font-size: smaller; }
+
+.gaia.captchahtml.desc { font-family: arial, sans-serif; font-size: smaller; } 
+.gaia.captchahtml.cmt { font-family: arial, sans-serif; font-size: smaller; font-style: italic; }
+  
+--></style>
+ 
+<style type="text/css"><!--
+    .body { margin-left: 3em;
+            margin-right: 5em;
+            font-family: arial,sans-serif; }
+
+    div.errorbox-good {}
+
+    div.errorbox-bad {} 
+
+    div.errormsg { color: red; font-size: smaller; font-family: arial,sans-serif;}
+    font.errormsg { color: red; font-size: smaller; font-family: arial,sans-serif;}
+    
+    hr {
+      border: 0;
+      background-color:#DDDDDD;
+      height: 1px;
+      width: 100%;
+      text-align: left;
+      margin: 5px;
+    }
+    
+--></style>
+<style type="text/css"><!--
+#error {
+	border: 1px dotted #cc9999;
+	margin-bottom: 10px;
+	padding: 6px 8px 6px 28px;
+	background: url(images/icon_alert.gif) left center no-repeat;
+	background-color: #fcfcfc;
+	color: #cc0000;
+}
+#foot {
+	width: 760px;
+	margin: 20px auto;
+	text-align: center;
+	padding: 5px;
+	font-size: 108%;
+	border-top: 1px solid #ccc;
+}
+
+#foot,
+#foot a {
+	background-color: inherit;
+	color: #999;
+}
+
+#foot a:hover {
+	background-color: inherit;
+	color: #70a8f1;
+}
+--></style>
+
+</head>
+<body dir="ltr" onload="gaia_setFocus();">
+<div id="main">
+  <table border="0" cellpadding="2" cellspacing="0" width="100%">
+    <tbody>
+      <tr>
+        <td colspan="2"><img alt="" height="2" width="1"></td>
+      </tr>
+      <tr>
+        <td valign="top" width="1%">
+          <img src="/cosign/images/services/Cosign_3d.gif" alt="CoSign" align="left" border="0">
+        </td>
+        <td valign="bottom">
+          <table border="0" cellpadding="0" cellspacing="0" width="100%">
+            <tbody>
+              <tr>
+                <td colspan="2"><img alt="" height="15" width="1"></td>
+              </tr>
+              <tr bgcolor="#3366cc">
+                <td colspan="2"><img alt="" height="1" width="1"></td>
+              </tr>
+              <tr bgcolor="#e5ecf9">
+                <td style="padding-left: 4px; padding-bottom: 3px; padding-top: 2px; font-family: arial,sans-serif;">
+                  <b><?php echo $username; ?> 的帐户</b>
+                </td>
+                <td style="padding-left: 4px; padding-bottom: 3px; padding-top: 2px; font-family: arial,sans-serif;" align="right">
+                  <a href="?logout">退出</a>&nbsp;&nbsp;&nbsp;&nbsp;
+                </td>
+              </tr>
+              <tr>
+                <td colspan="2"><img alt="" height="5" width="1"></td>
+              </tr>
+            </tbody>
+          </table>
+        </td>
+      </tr>
+    </tbody>
+  </table>
+  <br>
+  <table align="center" border="0" cellpadding="5" cellspacing="1" width="90%">
+    <tbody>
+      <tr>
+        <td style="padding-left: 10px;" align="left" valign="top">
+          <b>个人信息</b>
+          <hr color="#dddddd" noshade="noshade" size="1">
+          <br>
+          <ul>
+            <li><?php echo $username; ?></li>
+            <li><?php echo "$uid ($aliasname)"; ?></li>
+            <li><?php echo "$mail"; ?></li>
+            <li><a href="<?php echo $url_gosa; ?>">修改口令</a></li>
+          </ul>
+        </td>
+        <td valign="top" width="55%">
+          <b>Web 服务</b>
+          <hr color="#dddddd" noshade="noshade" size="1">
+          <div style="font-size: 83%;">
+            <br><br>
+<?php
+$has_services = false;
+$srvlist = dirname( dirname(__FILE__) ) . "/templates-local/zh/inc/*.html";
+foreach (glob($srvlist) as $filename) {
+  if (file_exists($filename))
+  {
+    $contents = file_get_contents($filename);
+    if ($contents)
+    {
+      $has_services = true;
+      echo ($contents);
+    }
+  }
+}
+if (! $has_services)
+{
+  echo "于下面的位置定义服务列表:<br>\n";
+  echo "<ul><li>$srvlist</li></ul>\n";
+}
+?>
+          </div>
+        </td>
+      </tr>
+    </tbody>
+  </table>
+  <br>
+  <br>
+<?php
+  $footer = dirname( dirname(__FILE__) ) . "/templates-local/zh/inc/footer.inc";
+  if (file_exists($footer))
+  {
+    $contents = file_get_contents($footer);
+    echo $contents;
+  }
+  else
+  {
+?>
+  <div id="foot">&copy; 2006-2010 <a href="http://www.umich.edu/~regents/" title="密歇根大学">密歇根大学</a>,
+       <a href="http://www.ossxp.com/">群英汇技术支持</a></div>
+<?php
+  }
+?>
+</body>
+</html>
+<!-- vim: set ts=2 sw=2 et : -->
diff --git a/html/services/ldap_api.php b/html/services/ldap_api.php
new file mode 100644
index 0000000..6a8d92d
--- /dev/null
+++ b/html/services/ldap_api.php
@@ -0,0 +1,107 @@
+<?php
+
+###########################################################################
+# LDAP API
+###########################################################################
+
+# force config variable from a global to avoid recursion
+function config_get( $p_option, $p_default = null ) {
+
+    if ( isset( $GLOBALS['g_' . $p_option] ) ) {
+        $t_value = $GLOBALS['g_' . $p_option];
+        if ( $t_value !== $GLOBALS['g_' . $p_option] ) {
+            $GLOBALS['g_' . $p_option] = $t_value;
+        }
+        return $t_value;
+    } else {
+        # unless we were allowing for the option not to exist by passing
+        #  a default, trigger a WARNING
+        return $p_default;
+    }
+}
+
+function is_blank( $p_var ) {
+    $p_var = trim( $p_var );
+    $str_len = strlen( $p_var );
+    if ( 0 == $str_len ) {
+        return true;
+    }
+    return false;
+}
+
+# --------------------
+# Connect and bind to the LDAP directory
+function ldap_connect_bind( $p_binddn = '', $p_password = '' ) {
+    $t_ldap_server	= config_get( 'ldap_server' );
+    $t_ldap_port	= config_get( 'ldap_port' );
+    if ( is_blank( $t_ldap_port ) ) {
+        $t_ldap_port = 389;
+    }
+    $t_ds = @ldap_connect ( $t_ldap_server, $t_ldap_port );
+    if ( $t_ds > 0 ) {
+        $t_protocol_version = config_get( 'ldap_protocol_version' );
+
+        if ( $t_protocol_version > 0 ) {
+            ldap_set_option( $t_ds, LDAP_OPT_PROTOCOL_VERSION, $t_protocol_version );
+        }
+
+        # If no Bind DN and Password is set, attempt to login as the configured
+        #  Bind DN.
+        if ( is_blank( $p_binddn ) && is_blank( $p_password ) ) {
+            $p_binddn	= config_get( 'ldap_bind_dn', '' );
+            $p_password	= config_get( 'ldap_bind_passwd', '' );
+        }
+
+        if ( !is_blank( $p_binddn ) && !is_blank( $p_password ) ) {
+            $t_br = @ldap_bind( $t_ds, $p_binddn, $p_password );
+        } else {
+            # Either the Bind DN or the Password are empty, so attempt an anonymous bind.
+            $t_br = @ldap_bind( $t_ds );
+        }
+    } 
+
+    return $t_ds;
+}
+
+# --------------------
+# Return an email address from LDAP, given a username
+function ldap_brief_info( $p_username ) {
+    $t_ldap_organization	= config_get( 'ldap_organization' );
+    $t_ldap_root_dn	    	= config_get( 'ldap_root_dn' );
+
+    $t_ldap_uid_field = config_get( 'ldap_uid_field', 'uid' ) ;
+    if (preg_match("/.*@.*\..*/", $p_username)) {
+        $t_search_filter	= "(&$t_ldap_organization(mail=$p_username))";
+    } else {
+        $t_search_filter	= "(&$t_ldap_organization($t_ldap_uid_field=$p_username))";
+    }
+    $t_search_attrs		= array( $t_ldap_uid_field, 'dn', 'givenName', 'sn', 'cn', 'mail' );
+    $t_ds           	= ldap_connect_bind();
+
+    $t_sr	= ldap_search( $t_ds, $t_ldap_root_dn, $t_search_filter, $t_search_attrs );
+    $t_info	= ldap_get_entries( $t_ds, $t_sr );
+    ldap_free_result( $t_sr );
+    ldap_unbind( $t_ds );
+
+    $result = array();
+    if ($t_info) {
+      $result['dn'] = $t_info[0]['dn'];
+      $result['givenname'] = $t_info[0]['givenname'][0];
+      $result['uid'] = $t_info[0][$t_ldap_uid_field][0];
+      $result['sn'] = $t_info[0]['sn'][0];
+      $result['cn'] = $t_info[0]['cn'][0];
+      $result['mail'] = $t_info[0]['mail'][0];
+    } else {
+      # May login through invite factor
+      $result['uid'] = $p_username;
+      $result['dn'] = '';
+      $result['givenname'] = '';
+      $result['sn'] = '';
+      $result['cn'] = '';
+      $result['mail'] = '';
+    }
+
+    return $result;
+}
+
+?>
-- 
tg: (b3dba5b..) t/services_template (depends on: t/static_htmls_to_templates)
