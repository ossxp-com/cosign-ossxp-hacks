From: Jiang Xin <worldhello.net@gmail.com>
Subject: [PATCH] t/bugfix_cosign_httponly_quirk

<patch description>

Signed-off-by: Jiang Xin <worldhello.net@gmail.com>

---
 filters/apache/mod_cosign.c  |   37 ++++++++++++++++---------------------
 filters/apache2/mod_cosign.c |   37 ++++++++++++++++---------------------
 2 files changed, 32 insertions(+), 42 deletions(-)

diff --git a/filters/apache/mod_cosign.c b/filters/apache/mod_cosign.c
index c983342..97e5905 100755
--- a/filters/apache/mod_cosign.c
+++ b/filters/apache/mod_cosign.c
@@ -143,27 +143,22 @@ set_cookie_and_redirect( request_rec *r, cosign_host_config *cfg )
     if ( cfg->siteentry != NULL && strcasecmp( cfg->siteentry, "none" ) != 0 ) {
 	ref = cfg->siteentry;
     } else {
-	/* live dangerously, we're redirecting to http */
-	if ( cfg->http == 1 ) {
-	    if ((( port = ap_get_server_port( r )) == 80 ) ||
-		    ( cfg->noappendport == 1 )) {
-		ref = ap_psprintf( r->pool, "http://%s%s", 
-			ap_get_server_name( r ), r->unparsed_uri );
-	    } else {
-		ref = ap_psprintf( r->pool, "http://%s:%d%s", 
-			ap_get_server_name( r ), port, r->unparsed_uri );
-	    }
-	/* live securely, redirecting to https */
-	} else {
-	    if ((( port = ap_get_server_port( r )) == 443 ) ||
-		    ( cfg->noappendport == 1 )) {
-		ref = ap_psprintf( r->pool, "https://%s%s", 
-			ap_get_server_name( r ), r->unparsed_uri );
-	    } else {
-		ref = ap_psprintf( r->pool, "https://%s:%d%s", 
-			ap_get_server_name( r ), port, r->unparsed_uri );
-	    }
-	}
+        /* always redirect to http/https if standard port. (OSSXP.COM) */
+        if (( port = ap_get_server_port( r )) == 80 ) {
+            ref = ap_psprintf( r->pool, "http://%s%s",
+                ap_get_server_name( r ), r->unparsed_uri );
+        } else if (( port = ap_get_server_port( r )) == 443 ) {
+            ref = ap_psprintf( r->pool, "https://%s%s",
+                ap_get_server_name( r ), r->unparsed_uri );
+        } else if ( cfg->http == 1 ) {
+            /* live dangerously, we're redirecting to http */
+            ref = ap_psprintf( r->pool, "http://%s:%d%s",
+                ap_get_server_name( r ), port, r->unparsed_uri );
+        } else {
+            /* live securely, redirecting to https */
+            ref = ap_psprintf( r->pool, "https://%s:%d%s",
+                ap_get_server_name( r ), port, r->unparsed_uri );
+        }
     }
 
     if ( cfg->reqfc > 0 ) {
diff --git a/filters/apache2/mod_cosign.c b/filters/apache2/mod_cosign.c
index aa49ffb..99ae3f5 100755
--- a/filters/apache2/mod_cosign.c
+++ b/filters/apache2/mod_cosign.c
@@ -150,27 +150,22 @@ set_cookie_and_redirect( request_rec *r, cosign_host_config *cfg )
     if ( cfg->siteentry != NULL && strcasecmp( cfg->siteentry, "none" ) != 0 ) {
 	ref = cfg->siteentry;
     } else {
-	/* live dangerously, we're redirecting to http */
-	if ( cfg->http == 1 ) {
-	    if ((( port = ap_get_server_port( r )) == 80 ) ||
-		    ( cfg->noappendport == 1 )) {
-		ref = apr_psprintf( r->pool, "http://%s%s",
-			ap_get_server_name( r ), r->unparsed_uri );
-	    } else {
-		ref = apr_psprintf( r->pool, "http://%s:%d%s",
-			ap_get_server_name( r ), port, r->unparsed_uri );
-	    }
-	/* live securely, redirecting to https */
-	} else {
-	    if ((( port = ap_get_server_port( r )) == 443 ) ||
-		    ( cfg->noappendport == 1 )) {
-		ref = apr_psprintf( r->pool, "https://%s%s",
-			ap_get_server_name( r ), r->unparsed_uri );
-	    } else {
-		ref = apr_psprintf( r->pool, "https://%s:%d%s",
-			ap_get_server_name( r ), port, r->unparsed_uri );
-	    }
-	}
+        /* always redirect to http/https if standard port. (OSSXP.COM) */
+        if (( port = ap_get_server_port( r )) == 80 ) {
+            ref = apr_psprintf( r->pool, "http://%s%s",
+                ap_get_server_name( r ), r->unparsed_uri );
+        } else if (( port = ap_get_server_port( r )) == 443 ) {
+            ref = apr_psprintf( r->pool, "https://%s%s",
+                ap_get_server_name( r ), r->unparsed_uri );
+        } else if ( cfg->http == 1 ) {
+            /* live dangerously, we're redirecting to http */
+            ref = apr_psprintf( r->pool, "http://%s:%d%s",
+                ap_get_server_name( r ), port, r->unparsed_uri );
+        } else {
+            /* live securely, redirecting to https */
+            ref = apr_psprintf( r->pool, "https://%s:%d%s",
+                ap_get_server_name( r ), port, r->unparsed_uri );
+        }
     }
 
     /* we need to remove this semi-colon eventually */
-- 
tg: (7da5ba0..) t/bugfix_cosign_httponly_quirk (depends on: master)
