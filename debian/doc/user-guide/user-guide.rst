================
单点登录
================

------------
用户手册
------------

:作者: 北京群英汇信息技术有限公司
:网址: http://www.ossxp.com/
:版本: 3.1.1-1
:日期: |date|
:版权信息: Creative Commons

.. contents:: 目录
.. sectnum::
.. header:: 单点登录用户手册
.. footer:: 北京群英汇信息技术有限公司
.. |date| date:: %Y-%m-%d %H:%M


访问单点登录系统
================
单点登录即 Single Sign-On，多个 web 应用仅需登录一次，是群英汇众多 web 应用的唯一登录入口。

什么是单点登录
--------------
群英汇的单点登录系统具有下列特点：

* 在有效期内，只需登录一次，降低频繁认证的复杂并减少口令泄漏风险
* 支持跨域认证，有效的整合各个 web 应用
* 唯一的登录入口，使用 https 协议，防止认证信息被窃取
* 支持多因子认证，可以为高安全级别应用提供访问授权
* 提供其他服务的入口。当登录成功后显示一个可定制的服务列表页
* 支持单点退出，即在一处退出登录，所有关联应用的登录状态自动失效

访问单点登录系统
----------------
访问单点登录系统的两个方法：

* 直接在浏览器中输入单点登录服务的 URL，如： https://weblogin.ossxp.com/
* 或者先访问某个 Web 应用，在相关应用中点击登录，跳转到单点登录 URL

以第一个方法举例：

* 访问单点登录系统，输入正确的用户名和口令
   .. figure:: images/weblogin.png
      :scale: 60

      单点登录对话框

  * 用户名字段填写登录 ID，也可以用邮件名替代，如果邮件地址具有唯一性
  * 缺省使用用户名和口令认证，也可以使用其他认证模式，如邀请码认证

* 登录成功，显示服务列表
   .. figure:: images/loggedin.png
      :scale: 60

      登录成功显示个人信息和服务列表

  * 左侧显示个人信息，并提供修改个人信息和口令的入口
  * 左侧个人信息的最下方，提供单点登出的链接
  * 右侧是单点登录系统整合的其他服务

单点登录的证书问题
==================
单点登录采用 HTTPS 协议，这必然会涉及到证书问题。因为大部分企业引入我们的系统，
是解决企业内部信息服务的整合和登录，而并非为企业客户提供诸如网银等安全认证。
因此企业没有必要花费高价去购买专业机构签发的证书，可以使用群英汇免费签发的证书。

使用群英汇签发或者企业自己签发的证书有一个问题：浏览器对证书不信任，并不能确认
访问的网站地址就是证书中声明的地址。因为：

* Internet Explorer, Firefox 等浏览器，内置了少数专业的认证公司的根证书
* 只有这些少数认证公司签发的证书在予以信任
* 由企业自行签发或群英汇签发的证书，由于签发者的根证书并不在 IE, FF 等浏览器中内置，
  导致证书不能被自动信任。

什么是证书
----------
我们知道 HTTP 协议在网络中是明文传输，会导致信息被监听，窃取，尤其是认证过程中，
用户名和口令的明文传输，风险最大。

而 HTTPS 协议则要安全的多。其安全性来自于两个方面。

1. 信道加密。网络中信息的传递是加密传输的，而加密的口令是 SSL 协商过程中创建的
   一次性随机口令。
2. 身份识别。服务器端的 SSL 公钥由第三方认证机构签名，声明该公钥仅限于某个域名
   或者某些域名使用。
   
   * 当连接的服务器的地址和证书中声明的地址不一致，弹出警告信息。
   * 同样，如果服务器的公钥不是权威机构签发，即使证书中域名和实际访问域名一致，
     浏览器也发出警告。

证书起到的作用就是上面第2点当中提到的身份识别问题，即提供防范中间人劫持。
中间人劫持，就是你请求认证的服务器被黑客通过技术手段偷换，造成您访问的服务器并非真正的服务器，
很多人在使用网银，在交易过程造成帐号泄漏，资金被盗，就是因为访问了钓鱼网站（被偷换的假的服务器）。 
证书，是防止钓鱼的最后的屏障。

浏览器的证书警告
----------------
如前所述，大部分企业部署我们的单点登录系统，没有去单点必要购买昂贵的 HTTPS 证书。
因为大部分企业引入我们的系统，是解决企业自身信息服务的整合和登录， 而并非为企业
的客户提供诸如网银等安全认证。

但是，这么一来，在员工登录单点登录系统时，浏览器会显示关于证书的警告信息。尤其是 IE7, IE8 
显示的警告信息最不友好，会让人误以为网站出现了异常！

我们先看看各色浏览器在遇到证书不可信的 Https 网站时的表现：

* IE7, IE8 访问单点登录，显示的证书警告

   .. figure:: images/ie7_cert_error.png
      :scale: 80

* 对于我们信任的网站，选择“忽略证书错误，继续访问”，而不要点击带有对号图标的选择，因为那样直接关闭浏览器。
  这样我们就可以浏览单点登录网站了。注意在标题栏有关于证书错误的提示。

   .. figure:: images/ie7_cert_ignore.png
      :scale: 100

* IE6 访问单点登录，显示的证书警告的对话框，选择“是”，就可以继续浏览。

   .. figure:: images/ie6_cert_error.png
      :scale: 100

* Firefox 访问单点登录，显示的证书警告。如果要浏览该网站，要点击“我已充分了解可能的风险”，按照提示操作即可访问。

   .. figure:: images/ff_cert_error.png
      :scale: 80

如何添加信任，避免浏览器证书警告
--------------------------------

有一个一劳永逸的方法，就是将群英汇的根证书导入浏览器中，就可以直接对证书建立信任，
不必在每次打开浏览器访问加密网站时，一遍又一遍的处理证书警告错误。我们以 IE7 为例：

* 浏览器输入地址 http://www.ossxp.com/ssl/ 。或者在您单点登录网站的 /ssl 目录也有我们根证书的拷贝。
  点击文件 ossxp-ca.crt 。

   .. figure:: images/ie7_cert_install1.png
      :scale: 100


* 打开 ossxp-ca.crt，显示该证书文件的详细信息。点击 “安装证书” 按钮。按照提示完成证书导入。

   .. figure:: images/ie7_cert_install2.png
      :scale: 100

* 将群英汇根证书正确导入后，再打开单点登录网站，不再出现证书警告信息，直接打开 HTTPS 网站。

   .. figure:: images/ie7_cert_ok.png
      :scale: 100

      浏览器的地址栏显示证书状态正常

双因子认证
==========
一些特殊的应用，要求用户通过更为严格的认证，一般采用称为“双因子认证”的认证模式。什么是双因子认证呢？

* 普通的认证，仅仅通过回答 "what you known" （知道什么）问题完成认证。

  如：口令认证模式，用户只需要提供自己所知道的口令或者用户名+口令的方式即完成认证。

* 双因子认证除了要回答普通认证的 "what you know" 问题，还要回答 "what you have" （有什么）的问题

  如：指纹认证，虹膜认证等都是常见的双因子认证。

群英汇单点登录认证系统，也包含了双因子认证。缺省提供了称为 admin 的认证因子，为部分应用软件提供基于双因子认证的授权服务。
Admin 双因子认证和上面提到的双因子认证又有所区别。

* Admin 认证因子实施认证前，需要先通过常规认证，即需要用户在回答了 "what you known" 之后，才进入到 admin 因子的认证
* Admin 认证因子，实现 "what you have" 问题，并不需要用户提供特别的东西，甚至根本不需要提供任何东西
* 实际上，admin 认证因子是查询后台数据库，确认已登录用户是否拥有特别的权限，如果该用户拥有相应权限，则认证成功
* 因此群英汇缺省提供的 admin 认证因子，用于向部分应用系统提供“认证+授权”服务

以邮件列表管理员登录为例。邮件列表管理员在访问邮件列表的管理接口的时候，向单点登录系统发出 admin_list 的认证因子请求。
单点登录系统会首先检查是否通过了口令认证，然后检查该用户是否属于 mailman 管理员用户组。下面展示一下双因子认证过程。

* 邮件列表一览页面（处于 **未** 登录状态）

   .. figure:: images/01_not_login.png
      :scale: 80

      尚未登录

* 点击登录，第一次进入单点登录界面

   .. figure:: images/02_first_login.png
      :scale: 80

      输入用户名口令完成 "what you konw" 的认证

* 处于登录状态的邮件列表一览页面

   .. figure:: images/03_logged_in.png
      :scale: 80

      登录成功。注意页面中有指向 **“列表管理界面”** 的链接

* 访问列表管理概览界面，再次跳转到单点登录，要求附加认证，即 admin 因子认证

   .. figure:: images/04_admin_factor_login.png
      :scale: 80

      注意浏览器地址栏的factors 参数以及页面中红色警告


* 如果再次认证过程中，输入错误的用户名口令，显示出错信息

   .. figure:: images/05_admin_factor_login_wrong_passwd.png
      :scale: 80

      输入错误的用户名或口令


* 如果用户不具有请求的管理员权限，显示出错信息

   .. figure:: images/06_admin_factor_login_failed.png
      :scale: 80

      因用户若不具有相应权限，admin 认证因子失败

* 如果通过 admin 认证因子，显示列表管理员概览页

   .. figure:: images/07_mailman_admin_pannel.png
      :scale: 80

      管理员概览页

邀请码登录
==========
邀请码认证是口令认证之外的另外一种认证方式。邀请码由管理员进行设置，为特殊用户提供无须用户注册即可访问某些服务。

* 在输入邀请码的同时，您需要在用户名字段输入您的邮件地址。
* 口令字段和邀请码字段互斥

  * 只有口令字段为空，邀请码才允许输入
  * 当邀请码字段处于输入焦点，口令字段自动隐藏
  * 只有当邀请码内容为空并且失去输入焦点，口令输入对话框才有效

示例：

* 邀请码登录，需要输入正确的邀请码，用户名处的邮件地址不作为验证依据

   .. figure:: images/invite_login.png
      :scale: 80

      邀请码登录

* 邀请码输入正确后，以该邀请码对应的用户帐号登录，本例为 demo 用户  

   .. figure:: images/invite_login_success.png
      :scale: 80

      邀请码登录成功


忘记口令和创建新帐号
====================
创建新帐号，获取忘记口令是和认证相关的两个重要的功能。实际上，这两个功能并非由单点登录系统本身提供，
而是由群英汇用户管理平台提供的功能。在群英汇用户管理平台的帮助中，会具体讲述自建帐号以及获取忘记口令的方法。

在这里，我们仅仅介绍一下单点登录平台提供的获取忘记口令以及自建帐号的链接。

在单点登录的用户名、口令输入对话框下面有一个“需要创建帐号或者找回口令？”的文字链接。
点击该链接，便在页面左侧弹出自建帐号以及获取忘记口令的帮助信息。

   .. figure:: images/change_password.png
      :scale: 80

      自建帐号和获取忘记口令的帮助



常见问题
========
单点登录并不意味着，所有应用的自动登录
--------------------------------------
错误的用户名和口令，错误输出
----------------------------
连续的认证错误，导致 443 端口被封锁一段时间
-------------------------------------------
循环重定向
----------
Valid 地址无效
--------------

