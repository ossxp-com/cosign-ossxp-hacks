From: Jiang Xin <worldhello.net@gmail.com>
Subject: [PATCH] Update build scripts for debian packaging

Update Makefiles so that debian packaging works properly.

 * Do 'make install' can install everything.
 * Add DESTDIR to filter and others.

Signed-off-by: Jiang Xin <worldhello.net@gmail.com>

---
 Makefile.in                 |   10 ++++++----
 filters/apache/Makefile.in  |    6 +++++-
 filters/apache2/Makefile.in |    5 ++++-
 libsnet/Makefile.in         |   15 ++++++++-------
 4 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index f5b1ffa..42dae1f 100755
--- a/Makefile.in
+++ b/Makefile.in
@@ -54,17 +54,19 @@ distclean: clean
 	rm -rf autom4te.cache
 	( cd tests && rm -rf *.testlog CA certs cosign openssl.cnf tmp )
 
-install: @FILTERS@
+install: install-all
+
+install-filter: @FILTERS@
 	for i in ${FILTERS}; \
-	    do (cd $$i; ${MAKE} ${MFLAGS} install); \
+	    do (cd $$i; ${MAKE} ${MFLAGS} install DESTDIR=$(DESTDIR)); \
 	done
 
 install-server : server
 	for i in ${SERVER_TARGETS}; \
-	    do (cd $$i; ${MAKE} ${MFLAGS} install); \
+	    do (cd $$i; ${MAKE} ${MFLAGS} install DESTDIR=$(DESTDIR)); \
 	done
 
 install-all : everything
 	for i in ${TARGETS}; \
-	    do (cd $$i; ${MAKE} ${MFLAGS} install); \
+	    do (cd $$i; ${MAKE} ${MFLAGS} install DESTDIR=$(DESTDIR)); \
 	done
diff --git a/filters/apache/Makefile.in b/filters/apache/Makefile.in
index 1c3f53a..27ca53d 100755
--- a/filters/apache/Makefile.in
+++ b/filters/apache/Makefile.in
@@ -8,6 +8,8 @@ CC=            	@CC@
 APXS=          	@APXS@
 APACHECTL=     	@APACHECTL@
 INSTALL=       	@INSTALL@
+DESTDIR=
+SBINDIR=@sbindir@
 
 
 #   additional user defines, includes and libraries
@@ -37,7 +39,9 @@ mod_cosign.so: ${SRC}
 #   install the DSO file into the Apache installation
 #   and activate it in the Apache configuration
 install: all
-	$(APXS) -i -a -n 'cosign' mod_cosign.so
+	#$(APXS) -i -a -n 'cosign' mod_cosign.so
+	-mkdir -p $(DESTDIR)${SBINDIR}
+	${INSTALL} -m 0755 -c mod_cosign.la $(DESTDIR)${SBINDIR}/;
 
 #   cleanup
 clean:
diff --git a/filters/apache2/Makefile.in b/filters/apache2/Makefile.in
index e6deae2..efab3f8 100755
--- a/filters/apache2/Makefile.in
+++ b/filters/apache2/Makefile.in
@@ -8,6 +8,8 @@ CC=             @CC@
 APXS2=          @APXS2@
 APACHECTL2=     @APACHECTL2@
 INSTALL=        @INSTALL@
+DESTDIR=
+SBINDIR=@sbindir@
 
 #    The apach 2 apxs build process tends to leave a lot of junk lying around.
 APXS2JUNKFILES=	../../common/argcargv.slo ../../common/argcargv.lo \
@@ -56,7 +58,8 @@ mod_cosign.la: ${SRC}
 #   install the DSO file into the Apache installation
 #   and activate it in the Apache configuration
 install: all
-	$(APXS2) -i -a -n 'cosign' mod_cosign.la
+	-mkdir -p $(DESTDIR)${SBINDIR}
+	${INSTALL} -m 0755 -c .libs/mod_cosign.so $(DESTDIR)${SBINDIR}/;
 
 #   cleanup
 clean:
diff --git a/libsnet/Makefile.in b/libsnet/Makefile.in
index 43205f8..8914dd9 100755
--- a/libsnet/Makefile.in
+++ b/libsnet/Makefile.in
@@ -6,6 +6,7 @@ VPATH=@srcdir@
 prefix      =	@prefix@
 libdir      =	@libdir@
 includedir  =	@includedir@
+DESTDIR=
 
 SRC  = snet.c
 OBJ  = snet.o
@@ -58,18 +59,18 @@ libsnet.la:	$(OBJ) $(LOBJ)
 	  -version-info 0:0:0 >/dev/null 2>&1 ) ; fi
 
 install:	all
-	mkdir -p $(libdir)
-	chmod 755 $(libdir)
-	mkdir -p $(includedir)
-	chmod 755 $(includedir)
-	$(INSTALL) -c -m 644 snet.h $(includedir)/snet.h
+	mkdir -p $(DESTDIR)$(libdir)
+	chmod 755 $(DESTDIR)$(libdir)
+	mkdir -p $(DESTDIR)$(includedir)
+	chmod 755 $(DESTDIR)$(includedir)
+	$(INSTALL) -c -m 644 snet.h $(DESTDIR)$(includedir)/snet.h
 	$(LIBTOOL) --mode=install \
-	  $(INSTALL) -c -m 644 libsnet.la $(libdir)/libsnet.la
+	  $(INSTALL) -c -m 644 libsnet.la $(DESTDIR)$(libdir)/libsnet.la
 	@if test x_$(PROFILED) = x_true ; then \
 	  echo "installing profiled libraries" ; \
 	  ( cd profiled ; ../$(LIBTOOL) --mode=install \
 	  $(INSTALL) -c -m 644 libsnet_p.la \
-	  $(libdir)/libsnet_p.la >/dev/null 2>&1 ) ; fi
+	  $(DESTDIR)$(libdir)/libsnet_p.la >/dev/null 2>&1 ) ; fi
 
 clean:
 	rm -f *.o *.lo *.slo libsnet.la
-- 
tg: (118a78f..) t/autotools_for_setup (depends on: master)
